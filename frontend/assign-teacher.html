<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Management</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"/>
<style>
  body {
    margin: 0;
    font-family: "Inter", sans-serif;
    background: linear-gradient(135deg, #0f172a, #1e293b, #0b132b);
    color: white;
    padding: 40px;
  }
  h1 { text-align: center; margin-bottom: 30px; color: #38bdf8; font-size: 32px; }
  .container { width: 90%; max-width: 900px; margin: auto; }
  .card { background: rgba(255,255,255,0.12); padding: 25px; border-radius: 14px; backdrop-filter: blur(10px); margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  label { font-weight: 500; }
  select, input { width: 100%; padding: 14px; border-radius: 8px; border: none; margin-top: 6px; margin-bottom: 15px; background: #e2e8f0; font-size: 15px; }
  button { width: 100%; padding: 14px; background: #38bdf8; border: none; font-size: 16px; font-weight: 600; border-radius: 8px; color: #0f172a; cursor: pointer; transition: .3s; }
  button:hover { background: #0ea5e9; transform: translateY(-3px); }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.15); }
  th { color: #38bdf8; font-size: 17px; }
  .btn-small { padding: 6px 10px; font-size: 14px; border-radius: 5px; margin-right: 6px; cursor: pointer; transition: .2s; }
  .edit-btn { background: #facc15; color: black; }
  .edit-btn:hover { background: #eab308; }
  .delete-btn { background: #ef4444; color: white; }
  .delete-btn:hover { background: #dc2626; }
  #toast { position: fixed; top: 20px; right: -300px; background: #22c55e; padding: 14px 20px; border-radius: 8px; transition: .6s; color: white; font-weight: 600; }
</style>
</head>
<body>

<div id="toast"></div>
<h1>Teacher Management</h1>

<div class="container">

  <!-- Assign Teacher -->
  <div class="card">
    <h2>Assign Teacher to Group</h2>
    <label>Select Group:</label>
    <select id="groupSelect"></select>

    <!-- <label>Select Teacher:</label>
    <select id="teacherSelect"></select> -->

    <label>Name:</label>
    <input type="text" id="name" placeholder="Enter name">

    <label>Subject:</label>
    <input type="text" id="subject" placeholder="Enter subject">

    <button onclick="assignTeacher()">Assign Teacher</button>
  </div>

  <!-- Teacher Assignments -->
  <div class="card">
    <h2>All Teacher Assignments</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Teacher</th>
          <th>Group</th>
          <th>Subject</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="assignmentsTable"></tbody>
    </table>
  </div>

</div>

<script>
const API = "http://localhost:5000/api/teacher";
const groupAPI = "http://localhost:5000/api/group";
const token = localStorage.getItem("token");

function showToast(msg, color="#22c55e") {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.background = color;
  t.style.right = "20px";
  setTimeout(() => { t.style.right = "-300px"; }, 2000);
}

// Load all groups
async function loadGroups() {
  try {
    const res = await fetch(groupAPI, { headers: { "Authorization": `Bearer ${token}` } });
    const groups = await res.json();
    const select = document.getElementById("groupSelect");
    select.innerHTML = `<option value="">Select Group</option>`;
    groups.forEach(g => select.innerHTML += `<option value="${g.id}">${g.name}</option>`);
  } catch(err) {
    console.error(err);
    showToast("Failed to load groups", "#ef4444");
  }
}

// Load all teachers
async function loadTeachers() {
  try {
    const res = await fetch("http://localhost:5000/api/auth?role=teacher", { // optionally add API to get all teachers
      headers: { "Authorization": `Bearer ${token}` }
    });
    const teachers = await res.json();
    const select = document.getElementById("teacherSelect");
    select.innerHTML = `<option value="">Select Teacher</option>`;
    teachers.forEach(t => select.innerHTML += `<option value="${t.id}">${t.name}</option>`);
  } catch(err) {
    console.error(err);
    showToast("Failed to load teachers", "#ef4444");
  }
}

// Assign teacher
async function assignTeacher() {
  const groupId = document.getElementById("groupSelect").value;
  const teacherId = document.getElementById("teacherSelect").value;
  const subject = document.getElementById("subject").value.trim();

  if(!groupId || !teacherId || !subject) return showToast("All fields are required", "#ef4444");

  try {
    const res = await fetch(`${API}/assign`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ groupId, teacherId, subject })
    });

    const data = await res.json();
    if(res.ok) {
      showToast("Teacher assigned successfully!");
      document.getElementById("subject").value = "";
      loadAssignments();
    } else {
      showToast(data.message || "Assignment failed", "#ef4444");
    }
  } catch(err) {
    console.error(err);
    showToast("Server error", "#ef4444");
  }
}

// Load all assignments
async function loadAssignments() {
  try {
    const res = await fetch(`${API}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    const assignments = await res.json();
    const table = document.getElementById("assignmentsTable");
    table.innerHTML = "";

    assignments.forEach(a => {
      table.innerHTML += `
        <tr>
          <td>${a.id}</td>
          <td>${a.teacherUser?.name || "-"}</td>
          <td>${a.groupInfo?.name || "-"}</td>
          <td><input type="text" id="sub${a.id}" value="${a.subject}" style="width: 90%"></td>
          <td>
            <button class="btn-small edit-btn" onclick="updateAssignment(${a.id})">Update</button>
            <button class="btn-small delete-btn" onclick="deleteAssignment(${a.id})">Delete</button>
          </td>
        </tr>
      `;
    });
  } catch(err) {
    console.error(err);
    showToast("Failed to load assignments", "#ef4444");
  }
}

// Update assignment
async function updateAssignment(id) {
  const subject = document.getElementById("sub"+id).value.trim();
  if(!subject) return showToast("Subject cannot be empty", "#ef4444");

  try {
    const res = await fetch(`${API}/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ subject })
    });

    if(res.ok) showToast("Assignment updated!");
    else showToast("Update failed", "#ef4444");
    loadAssignments();
  } catch(err) {
    console.error(err);
    showToast("Server error", "#ef4444");
  }
}

// Delete assignment
async function deleteAssignment(id) {
  try {
    const res = await fetch(`${API}/${id}`, {
      method: "DELETE",
      headers: { "Authorization": `Bearer ${token}` }
    });

    if(res.ok) showToast("Deleted!", "#ef4444");
    else showToast("Delete failed", "#ef4444");
    loadAssignments();
  } catch(err) {
    console.error(err);
    showToast("Server error", "#ef4444");
  }
}

// Initialize
loadGroups();
loadTeachers();
loadAssignments();
</script>

</body>
</html>
