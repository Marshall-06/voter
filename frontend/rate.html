<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rate Teacher</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
  .container { max-width: 800px; margin: 50px auto; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
  h1 { text-align: center; margin-bottom: 25px; color: #333; }
  label { display: block; margin-top: 15px; font-weight: 600; color: #555; }
  select, input { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
  button { width: 100%; padding: 14px; margin-top: 20px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; background: #007bff; color: white; transition: 0.3s; }
  button:hover { background: #0056b3; }
  .error, .success { text-align: center; margin-top: 15px; font-weight: 600; }
  .error { color: #e74c3c; }
  .success { color: #2ecc71; }
  #questionsContainer div { margin-bottom: 12px; }
  #questionsContainer input { width: 60px; display: inline-block; margin-left: 10px; }
</style>
</head>
<body>
<div class="container">
  <h1>Rate Your Teacher</h1>

  <form id="rateForm">
    <label for="groupSelect">Select Group</label>
    <select id="groupSelect" required>
      <option value="">Loading groups...</option>
    </select>

    <label for="teacherSelect">Select Teacher</label>
    <select id="teacherSelect" required>
      <option value="">Select group first</option>
    </select>

    <label for="subjectSelect">Select Subject</label>
    <select id="subjectSelect" required>
      <option value="">Select teacher first</option>
    </select>

    <div id="questionsContainer">
      <p>Loading questions...</p>
    </div>

    <button type="submit">Submit Rating</button>
  </form>

  <p id="message" class="success"></p>
  <p id="error" class="error"></p>
</div>

<script>
const API_URL = "http://localhost:5000/api"; // your backend URL
const token = localStorage.getItem("token");

if (!token) {
  alert("You must be logged in.");
  window.location.href = "index.html";
}

const groupSelect = document.getElementById("groupSelect");
const teacherSelect = document.getElementById("teacherSelect");
const subjectSelect = document.getElementById("subjectSelect");
const questionsContainer = document.getElementById("questionsContainer");
const rateForm = document.getElementById("rateForm");
const messageEl = document.getElementById("message");
const errorEl = document.getElementById("error");

// --- Load Groups ---
async function loadGroups() {
  try {
    const res = await fetch(`${API_URL}/group`, { headers: { Authorization: `Bearer ${token}` } });
    const data = await res.json();
    groupSelect.innerHTML = '<option value="">Select Group</option>';
    data.forEach(g => {
      const opt = document.createElement("option");
      opt.value = g.id;
      opt.textContent = g.name;
      groupSelect.appendChild(opt);
    });
  } catch (err) {
    groupSelect.innerHTML = '<option value="">Failed to load groups</option>';
  }
}

// --- Load Questions ---
async function loadQuestions() {
  try {
    const res = await fetch(`${API_URL}/question`, { headers: { Authorization: `Bearer ${token}` } });
    const data = await res.json();
    questionsContainer.innerHTML = "";
    if (data.length === 0) {
      questionsContainer.innerHTML = "<p>No questions available.</p>";
      return;
    }
    data.forEach(q => {
      const div = document.createElement("div");
      div.innerHTML = `
        <label>${q.text}</label>
        <input type="number" min="1" max="5" data-id="${q.id}" required>
      `;
      questionsContainer.appendChild(div);
    });
  } catch {
    questionsContainer.innerHTML = "<p>Failed to load questions</p>";
  }
}

// --- Load Teachers based on Group ---
groupSelect.addEventListener("change", async () => {
  const groupId = groupSelect.value;
  teacherSelect.innerHTML = '<option value="">Loading teachers...</option>';
  subjectSelect.innerHTML = '<option value="">Select teacher first</option>';
  if (!groupId) {
    teacherSelect.innerHTML = '<option value="">Select group first</option>';
    return;
  }
  try {
    const res = await fetch(`${API_URL}/teacher/group/${groupId}`, { headers: { Authorization: `Bearer ${token}` } });
    const data = await res.json();
    teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
    data.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.teacherId; // use manual teacherId
      opt.textContent = t.name;
      opt.dataset.subjects = JSON.stringify(t.subjects || []);
      teacherSelect.appendChild(opt);
    });
  } catch {
    teacherSelect.innerHTML = '<option value="">Failed to load teachers</option>';
  }
});

// --- Load Subjects based on Teacher ---
teacherSelect.addEventListener("change", () => {
  const selected = teacherSelect.selectedOptions[0];
  const subjects = selected ? JSON.parse(selected.dataset.subjects) : [];
  subjectSelect.innerHTML = '<option value="">Select Subject</option>';
  subjects.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    subjectSelect.appendChild(opt);
  });
});

// --- Submit Rating ---
rateForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  messageEl.textContent = "";
  errorEl.textContent = "";

  const teacherId = teacherSelect.value;
  const groupId = groupSelect.value;
  const subject = subjectSelect.value;

  if (!teacherId || !groupId || !subject) {
    errorEl.textContent = "Please select group, teacher, and subject.";
    return;
  }

  const answers = {};
  const inputs = document.querySelectorAll("#questionsContainer input");
  for (const input of inputs) {
    const val = Number(input.value);
    if (val < 1 || val > 5) {
      errorEl.textContent = "All scores must be between 1 and 5.";
      return;
    }
    answers[input.dataset.id] = val;
  }

  try {
    const res = await fetch(`${API_URL}/rate`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ teacherId, groupId, subject, answers })
    });
    const data = await res.json();
    if (res.ok) {
      messageEl.textContent = data.message || "Rating submitted successfully!";
      rateForm.reset();
      teacherSelect.innerHTML = '<option value="">Select group first</option>';
      subjectSelect.innerHTML = '<option value="">Select teacher first</option>';
    } else {
      errorEl.textContent = data.message || "Failed to submit rating";
    }
  } catch {
    errorEl.textContent = "Server error, please try again later.";
  }
});

// --- Initial Load ---
loadGroups();
loadQuestions();
</script>
</body>
</html>
